<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Fuel Price Story: The Balloon Effect</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            margin: 0; padding: 0;
            background: linear-gradient(135deg, #0a0e17 0%, #1a1f2e 100%);
            color: #e8eef7;
            overflow-x: hidden;
        }

        .container { max-width: 1400px; margin: 0 auto; padding: 30px 20px; }

        header { text-align: center; margin-bottom: 40px; }
        h1 {
            font-size: 42px; font-weight: 700; margin: 0 0 12px;
            background: linear-gradient(135deg, #6fa8ff 0%, #ffd166 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .subtitle { font-size: 18px; opacity: 0.8; margin: 0; }

        .story-mode {
            background: rgba(14, 20, 27, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(36, 48, 64, 0.8);
            border-radius: 16px;
            padding: 20px 24px;
            margin-bottom: 24px;
            display: flex;
            gap: 16px;
            align-items: center;
            flex-wrap: wrap;
        }

        .mode-btn {
            padding: 10px 20px;
            background: rgba(111, 168, 255, 0.1);
            border: 2px solid rgba(111, 168, 255, 0.3);
            border-radius: 8px;
            color: #6fa8ff;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .mode-btn:hover { background: rgba(111, 168, 255, 0.2); transform: translateY(-2px); }
        .mode-btn.active {
            background: #6fa8ff;
            color: #0a0e17;
            border-color: #6fa8ff;
            box-shadow: 0 4px 20px rgba(111, 168, 255, 0.4);
        }

        .narrative-text {
            flex: 1;
            min-width: 300px;
            font-size: 15px;
            line-height: 1.6;
            opacity: 0.9;
        }

        .viz-container {
            display: grid;
            grid-template-columns: 1fr 320px;
            gap: 20px;
            margin-bottom: 30px;
        }

        .main-viz, .timeline-viz, .distribution-viz {
            background: rgba(14, 20, 27, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(36, 48, 64, 0.8);
            border-radius: 16px;
            padding: 20px;
        }

        .main-viz { grid-column: 1; }
        .side-panel { grid-column: 2; display: flex; flex-direction: column; gap: 20px; }

        .viz-title {
            font-size: 16px;
            font-weight: 600;
            margin: 0 0 16px;
            opacity: 0.9;
        }

        svg { width: 100%; display: block; }

        .controls {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid rgba(36, 48, 64, 0.5);
        }

        .control-group { display: flex; align-items: center; gap: 8px; }
        .control-group label { font-size: 13px; opacity: 0.7; }

        select, input[type="range"] {
            background: rgba(36, 48, 64, 0.4);
            border: 1px solid rgba(111, 168, 255, 0.2);
            border-radius: 6px;
            color: #e8eef7;
            padding: 6px 10px;
            font-size: 13px;
            cursor: pointer;
        }

        input[type="range"] { width: 150px; }

        .y.axis text, .x.axis text { fill: #a9b8cc; font-size: 11px; }
        .y.axis line, .y.axis path, .x.axis line, .x.axis path { stroke: #2a3a50; }
        .axis-label { fill: #a9b8cc; font-size: 12px; font-weight: 500; }

        .balloon { cursor: grab; transition: opacity 0.3s ease; }
        .balloon:active { cursor: grabbing; }
        .balloon.dimmed { opacity: 0.2; }

        .timeline-marker {
            fill: rgba(111, 168, 255, 0.2);
            stroke: #6fa8ff;
            stroke-width: 2;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .timeline-marker:hover { fill: rgba(111, 168, 255, 0.4); }
        .timeline-marker.selected { fill: rgba(111, 168, 255, 0.6); stroke-width: 3; }

        .distribution-bar {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .distribution-bar:hover { opacity: 0.8; }

        .tooltip {
            position: absolute;
            pointer-events: none;
            background: rgba(16, 23, 35, 0.95);
            backdrop-filter: blur(10px);
            color: #e8eef7;
            border: 1px solid rgba(111, 168, 255, 0.3);
            border-radius: 10px;
            padding: 12px 14px;
            font-size: 13px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            opacity: 0;
            transform: translate(-50%, -110%);
            transition: opacity 0.2s ease;
            max-width: 250px;
        }

        .tooltip strong { color: #6fa8ff; }

        .insight-box {
            background: linear-gradient(135deg, rgba(111, 168, 255, 0.1) 0%, rgba(255, 209, 102, 0.1) 100%);
            border: 1px solid rgba(111, 168, 255, 0.2);
            border-radius: 12px;
            padding: 16px;
            margin-top: 20px;
        }

        .insight-box h3 {
            margin: 0 0 8px;
            font-size: 14px;
            font-weight: 600;
            color: #6fa8ff;
        }

        .insight-box p {
            margin: 0;
            font-size: 13px;
            line-height: 1.5;
            opacity: 0.9;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 12px;
        }

        .stat-card {
            background: rgba(36, 48, 64, 0.4);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #6fa8ff;
            margin: 0;
        }

        .stat-label {
            font-size: 11px;
            opacity: 0.7;
            margin: 4px 0 0;
        }

        @media (max-width: 1100px) {
            .viz-container { grid-template-columns: 1fr; }
            .side-panel { grid-column: 1; }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>The Balloon Effect</h1>
        <p class="subtitle">Understanding fuel prices through physics and data</p>
    </header>

    <div class="story-mode">
        <button class="mode-btn active" data-mode="explore">Explore</button>
        <button class="mode-btn" data-mode="years">Years</button>
        <button class="mode-btn" data-mode="compare">Compare</button>
        <button class="mode-btn" data-mode="trends">Trends</button>
        <button class="mode-btn" data-mode="impact">Impact</button>
        <div class="narrative-text" id="narrative">
            Drag balloons to feel the data. Higher prices float higher, bigger balloons cost more.
            Watch how gasoline and diesel prices move togetherâ€”yet drift apart.
        </div>
    </div>

    <div class="viz-container">
        <div class="main-viz">
            <div class="controls">
                <div class="control-group">
                    <label>Year:</label>
                    <select id="yearSelect">
                        <option value="all" selected>All Years</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Focus:</label>
                    <select id="gradeSelect">
                        <option value="premium|ultra_low_sulfur" selected>Premium + Ultra Low Sulfur</option>
                        <option value="midgrade|ultra_low_sulfur">Midgrade + Ultra Low Sulfur</option>
                        <option value="regular|ultra_low_sulfur">Regular + Ultra Low Sulfur</option>
                        <option value="all|all">All Grades</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Formulation:</label>
                    <select id="formulationSelect">
                        <option value="any" selected>Any</option>
                        <option value="conventional">Conventional</option>
                        <option value="reformulated">Reformulated</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Color by:</label>
                    <select id="colorMode">
                        <option value="fuel" selected>Fuel Type</option>
                        <option value="year">Year</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Physics:</label>
                    <input type="range" id="gravitySlider" min="0" max="10" value="5" step="1">
                    <span id="gravityLabel">Normal</span>
                </div>
            </div>
            <svg id="mainChart" viewBox="0 0 900 560" preserveAspectRatio="xMidYMid meet"></svg>
        </div>

        <div class="side-panel">
            <div class="timeline-viz">
                <h3 class="viz-title" id="timelineTitle">Price Timeline</h3>
                <svg id="timeline" viewBox="0 0 280 180" preserveAspectRatio="xMidYMid meet"></svg>
            </div>

            <div class="distribution-viz">
                <h3 class="viz-title">Price Distribution</h3>
                <svg id="distribution" viewBox="0 0 280 180" preserveAspectRatio="xMidYMid meet"></svg>
            </div>

            <div class="insight-box" id="insights">
                <h3>ðŸ’¡ Key Insights</h3>
                <p>Select a time period or price range to see insights.</p>
            </div>
        </div>
    </div>

    <div class="stat-grid">
        <div class="stat-card">
            <p class="stat-value" id="avgPrice">$0.00</p>
            <p class="stat-label">Average Price</p>
        </div>
        <div class="stat-card">
            <p class="stat-value" id="priceRange">$0.00</p>
            <p class="stat-label">Price Range</p>
        </div>
        <div class="stat-card">
            <p class="stat-value" id="gasDieselGap">$0.00</p>
            <p class="stat-label">Gas-Diesel Gap</p>
        </div>
        <div class="stat-card">
            <p class="stat-value" id="volatility">0%</p>
            <p class="stat-label">Volatility</p>
        </div>
    </div>
</div>

<div class="tooltip" id="tip"></div>

<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<script>
    (async function () {
        const csvUrl = "weekly_gas_prices.csv";
        let allData = await d3.csv(csvUrl, d => ({
            date: new Date(d.date),
            fuel: d.fuel,
            grade: d.grade,
            formulation: d.formulation,
            price: +d.price
        }));

        // Sample to 12 type combinations
        const grouped = d3.group(allData, d => `${d.fuel}|${d.grade}|${d.formulation}`);
        const typeKeys = Array.from(grouped.keys());
        const selectedTypes = d3.shuffle(typeKeys).slice(0, 12);
        const sampled = [];
        selectedTypes.forEach(typeKey => {
            const entries = grouped.get(typeKey);
            const step = Math.max(1, Math.floor(entries.length / 8));
            for (let i = 0; i < entries.length; i += step) {
                sampled.push(entries[i]);
            }
        });
        allData = sampled;

        // State
        let currentMode = 'explore';
        let selectedTimeRange = null;
        let currentGravity = 0.2;
        let colorByYear = false;

        // Extract years and populate selector
        const years = [...new Set(allData.map(d => d.date.getFullYear()))].sort();
        const yearSelect = document.getElementById("yearSelect");
        years.forEach(year => {
            const option = document.createElement("option");
            option.value = year;
            option.textContent = year;
            yearSelect.appendChild(option);
        });

        // Main chart setup
        const svg = d3.select("#mainChart");
        const W = 900, H = 560, margin = {top: 30, right: 30, bottom: 50, left: 70};
        const innerW = W - margin.left - margin.right;
        const innerH = H - margin.top - margin.bottom;
        const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

        // Background box
        g.append("rect")
            .attr("x", 0).attr("y", 0)
            .attr("width", innerW).attr("height", innerH)
            .attr("fill", "rgba(14, 20, 27, 0.3)")
            .attr("stroke", "#243040")
            .attr("rx", 12);

        const priceExtent = d3.extent(allData, d => d.price);
        const y = d3.scaleLinear().domain(priceExtent).range([innerH - 12, 12]).nice();
        const yAxis = d3.axisLeft(y).ticks(8, "~f");

        g.append("g").attr("class", "y axis").call(yAxis);
        g.append("text")
            .attr("class", "axis-label")
            .attr("x", -margin.left + 10)
            .attr("y", 12)
            .text("Price (USD/gal)");

        const fuelCats = ["gasoline", "diesel"];
        const x = d3.scalePoint().domain(fuelCats).range([120, innerW - 120]).padding(0.6);
        const r = d3.scaleSqrt().domain(priceExtent).range([8, 32]);
        const fuelColor = d3.scaleOrdinal().domain(fuelCats).range(["#6fa8ff", "#ffd166"]);
        const yearColor = d3.scaleSequential()
            .domain([d3.min(years), d3.max(years)])
            .interpolator(d3.interpolateViridis);

        function getColor(d) {
            return colorByYear ? yearColor(d.date.getFullYear()) : fuelColor(d.fuel);
        }

        // Fuel labels
        const fuelLabelsGroup = g.append("g").attr("class", "fuel-labels");
        fuelLabelsGroup.selectAll(".fuelLabel")
            .data(fuelCats).enter()
            .append("text")
            .attr("class", "fuelLabel")
            .attr("x", d => x(d))
            .attr("y", innerH + 30)
            .attr("text-anchor", "middle")
            .attr("fill", "#a9b8cc")
            .attr("font-size", 14)
            .attr("font-weight", 600)
            .text(d => d);

        // Year legend (shown when coloring by year)
        const yearLegendGroup = g.append("g")
            .attr("class", "year-legend")
            .attr("transform", `translate(${innerW - 100}, 10)`)
            .style("display", "none");

        function updateYearLegend() {
            yearLegendGroup.style("display", colorByYear ? "block" : "none");
            if (!colorByYear) return;

            yearLegendGroup.selectAll("*").remove();

            const legendYears = years.slice(0, Math.min(5, years.length)); // Show up to 5 years

            legendYears.forEach((year, i) => {
                yearLegendGroup.append("circle")
                    .attr("cx", 0)
                    .attr("cy", i * 18)
                    .attr("r", 5)
                    .attr("fill", yearColor(year));

                yearLegendGroup.append("text")
                    .attr("x", 10)
                    .attr("y", i * 18 + 4)
                    .attr("font-size", 11)
                    .attr("fill", "#a9b8cc")
                    .text(year);
            });
        }

        // Gradients
        const defs = svg.append("defs");
        const grad = defs.append("radialGradient").attr("id", "balloonGlow")
            .attr("cx", "35%").attr("cy", "30%");
        grad.append("stop").attr("offset", "0%").attr("stop-color", "white").attr("stop-opacity", 0.8);
        grad.append("stop").attr("offset", "60%").attr("stop-color", "white").attr("stop-opacity", 0.2);
        grad.append("stop").attr("offset", "100%").attr("stop-color", "white").attr("stop-opacity", 0);

        const tip = d3.select("#tip");
        const fmt = d3.format(".3f");

        let sim;

        function boundForce(x0, y0, w, h, pad = 2) {
            return function () {
                for (const d of sim.nodes()) {
                    d.x = Math.max(x0 + pad + d.r, Math.min(x0 + w - pad - d.r, d.x));
                    d.y = Math.max(y0 + pad + d.r, Math.min(y0 + h - pad - d.r, d.y));
                }
            };
        }

        function renderMain(data) {
            const nodes = data.map(d => ({
                ...d,
                targetX: x(d.fuel),
                targetY: y(d.price),
                r: r(d.price)
            }));

            const sel = g.selectAll(".balloonGroup").data(nodes, d => `${d.date}-${d.fuel}-${d.grade}`);

            sel.exit()
                .transition().duration(500)
                .attr("transform", d => `translate(${d.x || 0},${innerH + 50})`)
                .style("opacity", 0)
                .remove();

            const enter = sel.enter().append("g")
                .attr("class", "balloonGroup balloon")
                .attr("transform", d => `translate(${x(d.fuel)},${innerH})`)
                .style("opacity", 0);

            enter.append("line")
                .attr("class", "string")
                .attr("x1", 0).attr("y1", 0)
                .attr("x2", 0).attr("y2", d => d.r + 22)
                .attr("stroke", "#415974")
                .attr("stroke-width", 1.5)
                .attr("opacity", .7);

            enter.append("circle")
                .attr("class", "balloonBody")
                .attr("r", d => d.r)
                .attr("fill", d => getColor(d))
                .attr("fill-opacity", 0.85)
                .attr("stroke", "#0b0f14")
                .attr("stroke-width", 1);

            enter.append("circle")
                .attr("r", d => d.r)
                .attr("fill", "url(#balloonGlow)")
                .attr("pointer-events", "none");

            enter.append("path")
                .attr("d", d => `M ${-2.5} ${d.r-1} L 0 ${d.r+5} L 2.5 ${d.r-1} Z`)
                .attr("fill", "#1b2635")
                .attr("opacity", .9);

            const merged = enter.merge(sel);

            // Update colors for existing balloons
            merged.select(".balloonBody")
                .transition().duration(500)
                .attr("fill", d => getColor(d));

            merged
                .on("mousemove", (e, d) => {
                    tip
                        .style("left", e.pageX + "px")
                        .style("top", e.pageY + "px")
                        .style("opacity", 1)
                        .html(`
            <strong>${d.fuel}</strong> â€” ${d.grade}<br>
            ${d.formulation ? d.formulation + '<br>' : ''}
            ${d.date.toLocaleDateString()}<br>
            <strong>$${fmt(d.price)}</strong>/gal
          `);
                })
                .on("mouseleave", () => tip.style("opacity", 0))
                .call(d3.drag()
                    .on("start", (e, d) => {
                        if (!e.active) sim.alphaTarget(0.3).restart();
                        d.fx = d.x; d.fy = d.y;
                    })
                    .on("drag", (e, d) => {
                        d.fx = e.x; d.fy = e.y;
                    })
                    .on("end", (e, d) => {
                        if (!e.active) sim.alphaTarget(0);
                        d.fx = null; d.fy = null;
                    }));

            enter.transition()
                .duration(800)
                .delay((d, i) => i * 30)
                .style("opacity", 1)
                .attr("transform", d => `translate(${d.targetX},${d.targetY})`);

            if (sim) sim.stop();

            sim = d3.forceSimulation(nodes)
                .force("x", d3.forceX(d => d.targetX).strength(0.15))
                .force("y", d3.forceY(d => d.targetY).strength(currentGravity))
                .force("collide", d3.forceCollide(d => d.r + 2))
                .alphaDecay(0.03)
                .on("tick", () => {
                    merged.attr("transform", d => `translate(${d.x},${d.y})`);
                });

            sim.force("bounds", boundForce(0, 0, innerW, innerH, 8));

            updateStats(data);
        }

        // Timeline
        const timelineSvg = d3.select("#timeline");
        const tW = 280, tH = 180, tM = {top: 20, right: 20, bottom: 30, left: 40};
        const tInnerW = tW - tM.left - tM.right;
        const tInnerH = tH - tM.top - tM.bottom;
        const tg = timelineSvg.append("g").attr("transform", `translate(${tM.left},${tM.top})`);

        function renderTimeline(data) {
            const timelineTitle = document.getElementById("timelineTitle");

            if (currentMode === "years") {
                timelineTitle.textContent = "Year Comparison";
                renderYearComparison(data);
            } else {
                timelineTitle.textContent = "Price Timeline";
                renderTimelinePath(data);
            }
        }

        function renderYearComparison(data) {
            const byYear = d3.rollup(data,
                v => ({
                    avg: d3.mean(v, d => d.price),
                    min: d3.min(v, d => d.price),
                    max: d3.max(v, d => d.price),
                    count: v.length
                }),
                d => d.date.getFullYear()
            );
            const yearData = Array.from(byYear, ([year, stats]) => ({year, ...stats}))
                .sort((a, b) => a.year - b.year);

            const tx = d3.scaleBand()
                .domain(yearData.map(d => d.year))
                .range([0, tInnerW])
                .padding(0.2);
            const ty = d3.scaleLinear()
                .domain([0, d3.max(yearData, d => d.max)])
                .range([tInnerH, 0])
                .nice();

            tg.selectAll("*").remove();

            // Bars for each year
            tg.selectAll(".year-bar")
                .data(yearData)
                .join("rect")
                .attr("class", "year-bar")
                .attr("x", d => tx(d.year))
                .attr("y", d => ty(d.avg))
                .attr("width", tx.bandwidth())
                .attr("height", d => tInnerH - ty(d.avg))
                .attr("fill", d => yearColor(d.year))
                .attr("opacity", 0.7)
                .attr("rx", 3)
                .style("cursor", "pointer")
                .on("click", (e, d) => {
                    yearSelect.value = d.year;
                    applyFilter();
                })
                .on("mouseenter", function() {
                    d3.select(this).attr("opacity", 1);
                })
                .on("mouseleave", function() {
                    d3.select(this).attr("opacity", 0.7);
                });

            // Error bars (min/max)
            tg.selectAll(".year-range")
                .data(yearData)
                .join("line")
                .attr("class", "year-range")
                .attr("x1", d => tx(d.year) + tx.bandwidth() / 2)
                .attr("x2", d => tx(d.year) + tx.bandwidth() / 2)
                .attr("y1", d => ty(d.min))
                .attr("y2", d => ty(d.max))
                .attr("stroke", "#e8eef7")
                .attr("stroke-width", 2)
                .attr("opacity", 0.5);

            tg.append("g")
                .attr("class", "x axis")
                .attr("transform", `translate(0,${tInnerH})`)
                .call(d3.axisBottom(tx));

            tg.append("g")
                .attr("class", "y axis")
                .call(d3.axisLeft(ty).ticks(4, "$.2f"));
        }

        function renderTimelinePath(data) {
            const byDate = d3.rollup(data, v => d3.mean(v, d => d.price), d => d.date);
            const timeData = Array.from(byDate, ([date, price]) => ({date, price}))
                .sort((a, b) => a.date - b.date);

            const tx = d3.scaleTime()
                .domain(d3.extent(timeData, d => d.date))
                .range([0, tInnerW]);
            const ty = d3.scaleLinear()
                .domain(d3.extent(timeData, d => d.price))
                .range([tInnerH, 0])
                .nice();

            tg.selectAll("*").remove();

            const line = d3.line()
                .x(d => tx(d.date))
                .y(d => ty(d.price))
                .curve(d3.curveMonotoneX);

            tg.append("path")
                .datum(timeData)
                .attr("fill", "none")
                .attr("stroke", "#6fa8ff")
                .attr("stroke-width", 2)
                .attr("d", line);

            tg.selectAll(".timeline-marker")
                .data(timeData)
                .join("circle")
                .attr("class", "timeline-marker")
                .attr("cx", d => tx(d.date))
                .attr("cy", d => ty(d.price))
                .attr("r", 4)
                .on("click", (e, d) => {
                    selectedTimeRange = d.date;
                    highlightTimeRange(d.date);
                });

            tg.append("g")
                .attr("class", "x axis")
                .attr("transform", `translate(0,${tInnerH})`)
                .call(d3.axisBottom(tx).ticks(4).tickFormat(d3.timeFormat("%b '%y")));
        }

        function highlightTimeRange(date) {
            const filtered = allData.filter(d =>
                Math.abs(d.date - date) < 30 * 24 * 60 * 60 * 1000
            );

            g.selectAll(".balloon")
                .classed("dimmed", d => Math.abs(d.date - date) >= 30 * 24 * 60 * 60 * 1000);

            updateInsights(filtered, date);
        }

        // Distribution
        const distSvg = d3.select("#distribution");
        const dg = distSvg.append("g").attr("transform", `translate(${tM.left},${tM.top})`);

        function renderDistribution(data) {
            const bins = d3.bin()
                .domain(priceExtent)
                .thresholds(12)(data.map(d => d.price));

            const dx = d3.scaleBand()
                .domain(bins.map((d, i) => i))
                .range([0, tInnerW])
                .padding(0.1);
            const dy = d3.scaleLinear()
                .domain([0, d3.max(bins, d => d.length)])
                .range([tInnerH, 0]);

            dg.selectAll("*").remove();

            dg.selectAll(".distribution-bar")
                .data(bins)
                .join("rect")
                .attr("class", "distribution-bar")
                .attr("x", (d, i) => dx(i))
                .attr("y", d => dy(d.length))
                .attr("width", dx.bandwidth())
                .attr("height", d => tInnerH - dy(d.length))
                .attr("fill", "#ffd166")
                .attr("opacity", 0.7)
                .on("click", (e, bin) => {
                    const filtered = data.filter(d => d.price >= bin.x0 && d.price < bin.x1);
                    g.selectAll(".balloon")
                        .classed("dimmed", d => d.price < bin.x0 || d.price >= bin.x1);
                    updateInsights(filtered, null, bin);
                });

            dg.append("g")
                .attr("class", "x axis")
                .attr("transform", `translate(0,${tInnerH})`)
                .call(d3.axisBottom(dx).tickFormat((d, i) => i % 3 === 0 ? fmt(bins[d].x0) : ""));
        }

        function updateStats(data) {
            const prices = data.map(d => d.price);
            const gasPrices = data.filter(d => d.fuel === "gasoline").map(d => d.price);
            const dieselPrices = data.filter(d => d.fuel === "diesel").map(d => d.price);

            document.getElementById("avgPrice").textContent = "$" + d3.mean(prices).toFixed(2);
            document.getElementById("priceRange").textContent = "$" + (d3.max(prices) - d3.min(prices)).toFixed(2);

            if (gasPrices.length && dieselPrices.length) {
                document.getElementById("gasDieselGap").textContent =
                    "$" + Math.abs(d3.mean(gasPrices) - d3.mean(dieselPrices)).toFixed(2);
            }

            const variance = d3.variance(prices);
            document.getElementById("volatility").textContent =
                variance ? (Math.sqrt(variance) / d3.mean(prices) * 100).toFixed(1) + "%" : "0%";

            // Update insights with current filter
            updateInsights(data);
        }

        function updateInsights(data, date, bin) {
            const insights = document.getElementById("insights");
            let html = "<h3>ðŸ’¡ Insights</h3>";

            if (date) {
                html += `<p><strong>${date.toLocaleDateString()}</strong>: `;
                html += `${data.length} data points. `;
                const avgPrice = d3.mean(data, d => d.price);
                html += `Average price was ${avgPrice.toFixed(2)}/gal.</p>`;
            } else if (bin) {
                html += `<p><strong>Price range ${bin.x0.toFixed(2)}-${bin.x1.toFixed(2)}</strong>: `;
                html += `${data.length} observations. `;
                const fuels = d3.group(data, d => d.fuel);
                html += `${fuels.get("gasoline")?.length || 0} gasoline, ${fuels.get("diesel")?.length || 0} diesel.</p>`;
            } else {
                // Year-based insights if a year is selected
                const selectedYear = yearSelect.value;
                if (selectedYear !== "all") {
                    const yearData = data.filter(d => d.date.getFullYear().toString() === selectedYear);
                    const avgPrice = d3.mean(yearData, d => d.price);
                    const minPrice = d3.min(yearData, d => d.price);
                    const maxPrice = d3.max(yearData, d => d.price);
                    html += `<p><strong>${selectedYear} Summary</strong><br>`;
                    html += `Average: ${avgPrice.toFixed(2)}/gal<br>`;
                    html += `Range: ${minPrice.toFixed(2)} - ${maxPrice.toFixed(2)}<br>`;
                    html += `Spread: ${(maxPrice - minPrice).toFixed(2)}</p>`;
                } else {
                    html += `<p>Select a point on the timeline, a year, or click a bar in the distribution to explore patterns.</p>`;
                }
            }

            insights.innerHTML = html;
        }

        // Mode switching
        const modeButtons = document.querySelectorAll(".mode-btn");
        const narrative = document.getElementById("narrative");

        const narratives = {
            explore: "Drag balloons to feel the data. Higher prices float higher, bigger balloons cost more. Watch how gasoline and diesel prices move togetherâ€”yet drift apart.",
            years: "Compare prices across years. Switch color mode to 'Year' to see temporal patterns. Select a specific year to isolate it, or view all years together to spot trends.",
            compare: "Click the timeline to compare prices across time. Notice how market events create waves that lift all fuels together.",
            trends: "Use the distribution chart to see price clustering. Most prices fall in the middle range, but outliers tell stories of crisis and calm.",
            impact: "Adjust the physics slider. Lower gravity = prices matter less. Higher gravity = every cent pulls harder. What would your budget feel?"
        };

        modeButtons.forEach(btn => {
            btn.addEventListener("click", () => {
                modeButtons.forEach(b => b.classList.remove("active"));
                btn.classList.add("active");
                currentMode = btn.dataset.mode;
                narrative.textContent = narratives[currentMode];

                if (currentMode === "compare") {
                    renderTimeline(allData);
                } else if (currentMode === "trends") {
                    renderDistribution(allData);
                } else if (currentMode === "years") {
                    renderTimeline(allData);
                }
            });
        });

        // Gravity control
        const gravitySlider = document.getElementById("gravitySlider");
        const gravityLabel = document.getElementById("gravityLabel");
        const gravityLabels = ["Weightless", "Light", "Floaty", "Gentle", "Soft", "Normal", "Firm", "Strong", "Heavy", "Crushing", "Extreme"];

        gravitySlider.addEventListener("input", (e) => {
            const val = +e.target.value;
            gravityLabel.textContent = gravityLabels[val];
            currentGravity = 0.05 + (val * 0.03);
            if (sim) {
                sim.force("y", d3.forceY(d => d.targetY).strength(currentGravity));
                sim.alpha(0.5).restart();
            }
        });

        // Filter controls
        const gradeSelect = document.getElementById("gradeSelect");
        const formulationSelect = document.getElementById("formulationSelect");
        const colorModeSelect = document.getElementById("colorMode");

        colorModeSelect.addEventListener("change", (e) => {
            colorByYear = e.target.value === "year";
            updateYearLegend();
            applyFilter();
        });

        yearSelect.addEventListener("change", applyFilter);

        function applyFilter() {
            const selectedYear = yearSelect.value;
            const [gasGood, dieselGood] = gradeSelect.value.split("|");
            const form = formulationSelect.value;

            const filtered = allData.filter(d => {
                const yearOK = selectedYear === "all" || d.date.getFullYear().toString() === selectedYear;
                const gasOK = d.fuel === "gasoline" && (gasGood === "all" || d.grade === gasGood);
                const diesOK = d.fuel === "diesel" && (dieselGood === "all" || d.grade === dieselGood);
                const gradeOK = (gasOK || diesOK) || (gasGood === "all" && dieselGood === "all");
                const formOK = (form === "any") || (d.formulation || "all") === form;
                return yearOK && gradeOK && formOK && !isNaN(d.price);
            });

            renderMain(filtered);
            renderTimeline(filtered);
            renderDistribution(filtered);
        }

        gradeSelect.addEventListener("change", applyFilter);
        formulationSelect.addEventListener("change", applyFilter);

        updateYearLegend();
        applyFilter();
    })();
</script>
</body>
</html>